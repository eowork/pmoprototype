# DTO ↔ Schema Revision (Construction Modules)

## Status Log
- Status: Completed initial verification for construction-projects DTOs and construction-subcategories DTOs against `database\database draft\2026_01_12\pmo_schema_pg.sql`.
- Scope: DTO files explicitly listed in request + relevant schema sections (construction_projects, construction_subcategories, construction_* detail tables).
- Note: `pmo_migration_google_oauth.sql` is unrelated to construction DTO/schema alignment (it only alters `users.google_id`).

## Summary Log
- Most “missing” attributes in DTOs are intentionally omitted because they are DB-managed (UUID defaults, BIGSERIAL, timestamps, soft-delete fields) or server-managed (created_by/updated_by from auth context, project_id from route params).
- There are two schema-vs-API shape mismatches that are not “intentional omissions”:
  - `construction_gallery` schema is **not aligned** with the backend’s gallery implementation pattern (backend logic expects file_* columns; schema draft defines image_url/caption only).
  - Schema contains both `construction_milestones` and `construction_project_milestones`; the DTO matches the simpler `construction_milestones` table while the “detailed” milestones table is not represented by the current DTO set.

---

## Research Findings (Direct Comparisons)

### 1) construction_projects ↔ CreateConstructionProjectDto / UpdateConstructionProjectDto / QueryConstructionProjectDto

#### Schema (construction_projects) key columns
- Identity / system:
  - `id` UUID DEFAULT gen_random_uuid()
  - `infra_project_uid` BIGSERIAL UNIQUE
  - `created_at`, `updated_at`, `deleted_at`, `deleted_by`
  - `created_by`, `updated_by`
- Business fields (selected):
  - `project_id`, `project_code`, `title`, `description`, `contract_amount`, dates, campus, status
  - `physical_progress` DEFAULT 0.00
  - `financial_progress` DEFAULT 0.00
  - `timeline_data` JSONB DEFAULT []
  - `gallery_images` JSONB DEFAULT []
  - `location_coordinates` POINT
  - `latitude`, `longitude`

#### DTO coverage
- CreateConstructionProjectDto includes core editable/business fields only (project identifiers, descriptive fields, contractor/funding references, dates, status/campus, lat/long, metadata).

#### Why schema attributes are missing from CreateConstructionProjectDto
- DB-generated identifiers:
  - `id` is generated by DB default.
  - `infra_project_uid` is BIGSERIAL; should not be client-supplied.
- Server-managed audit fields:
  - `created_by` is taken from the authenticated user and set in the service insert (not user input).
  - `updated_by` is set during updates, not creates.
  - Timestamps (`created_at`, `updated_at`) and soft-delete columns (`deleted_at`, `deleted_by`) are DB/system-managed.
- Default/derived fields intentionally not set at create:
  - `physical_progress`, `financial_progress`, `timeline_data`, `gallery_images` have safe defaults in the schema; omitting them keeps “create” minimal and prevents clients from spoofing progress/history.
- Not implemented field mapping:
  - `location_coordinates` (POINT) exists in schema but DTO only exposes `latitude` and `longitude`. There is no DTO field for POINT and no evidence (in the reviewed DTO list) of a transformation layer that builds POINT from lat/long. This is a schema/API mismatch (either drop POINT or implement mapping).

#### UpdateConstructionProjectDto
- It is `PartialType(CreateConstructionProjectDto)` so it inherits the create shape.
- Effect: you currently cannot update fields that are not in CreateConstructionProjectDto (e.g., physical_progress, financial_progress, timeline_data, gallery_images). If those must be editable, they need explicit DTO/service support.

#### QueryConstructionProjectDto
- It filters by: `status`, `campus`, `contractor_id`, `funding_source_id`.
- Why other columns are “missing”:
  - Query DTOs typically expose only product-required filters. The schema has many columns but the API’s filter surface is intentionally small.

---

### 2) construction_project_financials ↔ CreateConstructionFinancialDto

#### Schema (construction_project_financials) key columns
- `id` UUID DEFAULT gen_random_uuid()
- `project_id` UUID (FK)
- `fiscal_year`, `appropriation`, `obligation`, `disbursement` DEFAULT 0
- `metadata`, `created_at`, `updated_at`, `deleted_at`, `deleted_by`

#### DTO coverage
- CreateConstructionFinancialDto includes:
  - `fiscal_year`, `appropriation`, `obligation`, optional `disbursement`, optional `metadata`

#### Why schema attributes are missing from the DTO
- `project_id` is typically provided by the route/endpoint context (e.g., `/construction-projects/:projectId/financials`) rather than in payload.
- `id`, timestamps, and soft-delete fields are DB/system-managed.
- `disbursement` is optional because schema provides a default (`0`) and API can allow omission.

---

### 3) construction_milestones / construction_project_milestones ↔ CreateMilestoneDto

#### Schema situation
- The schema defines two milestone tables:
  - `construction_milestones` (simple model: target_date, actual_date, remarks, created_at)
  - `construction_project_milestones` (detailed model: start/end/actual_* dates, progress, created_at/updated_at/deleted_at)

#### DTO coverage
- CreateMilestoneDto (in your current code) matches the *simple* table concept:
  - `title`, `description?`, `target_date?`, `actual_date?`, `status?`, `remarks?`

#### Why attributes appear “missing” (depending which table you compare against)
- If comparing DTO to `construction_milestones`:
  - Missing `id`, `project_id`, `created_at` is expected (DB default + route param + DB timestamp).
- If comparing DTO to `construction_project_milestones`:
  - The DTO does not include `start_date/end_date/actual_start_date/actual_end_date/progress/updated_at/deleted_at` because it is not modeling that table.
  - Root cause is not “DTO omission”; it is that the API/DTO is designed for the other milestone table.

---

### 4) construction_gallery ↔ CreateGalleryDto / QueryGalleryDto

#### Schema (construction_gallery) columns
- `id` UUID DEFAULT gen_random_uuid()
- `project_id` UUID (FK)
- `image_url` VARCHAR(500) NOT NULL
- `caption` VARCHAR(255)
- `category` VARCHAR(50) DEFAULT 'PROGRESS'
- `is_featured` BOOLEAN DEFAULT FALSE
- `uploaded_at` TIMESTAMPTZ DEFAULT NOW()

#### DTO coverage
- CreateGalleryDto includes: `category`, `image_url?`, `caption?`, `is_featured?`
- QueryGalleryDto includes: `category?` (as enum)

#### Why schema attributes are missing from the DTO
- Expected omissions:
  - `id`, `project_id`, `uploaded_at` are DB/system/route-managed.
- Potential DTO/schema inconsistencies:
  - Schema requires `image_url NOT NULL`, but DTO marks `image_url` optional. If the API truly requires image_url in payload, DTO should enforce requiredness.
  - Schema uses `category VARCHAR(50)` while DTO uses `GalleryCategory` enum. This is acceptable if the enum values map to stored strings and you want stricter validation at API level.

#### Important mismatch warning (schema vs backend implementation)
- The reviewed schema defines `image_url/caption/...`, but the backend gallery feature (as commonly implemented in this codebase pattern) appears to be file-upload based (storing file_name/file_path/mime_type/etc.). If your service layer is already using that shape, the schema draft needs to be updated to match; otherwise runtime SQL inserts/selects will fail.

---

## Construction Subcategories (DTOs ↔ Schema)

### construction_subcategories ↔ CreateConstructionSubcategoryDto / UpdateConstructionSubcategoryDto / QueryConstructionSubcategoryDto

#### Schema (construction_subcategories) columns
- `id` UUID DEFAULT gen_random_uuid()
- `name` VARCHAR(100) NOT NULL UNIQUE
- `description` TEXT
- `metadata` JSONB
- `created_at`, `updated_at`, `deleted_at`, `deleted_by`

#### DTO coverage
- CreateConstructionSubcategoryDto: `name`, `description?`, `metadata?`
- UpdateConstructionSubcategoryDto: PartialType(Create)
- QueryConstructionSubcategoryDto: pagination + sorting + optional `name` filter

#### Why schema attributes are missing from the DTOs
- `id`, timestamps, and soft-delete fields are DB/system-managed and should not be user-provided.
- Query DTO does not expose every schema column as a filter; it only supports what the API needs (`name` plus paging/sorting).

---

## Research Log (What was checked)
- Schema source: `database\database draft\2026_01_12\pmo_schema_pg.sql`
  - construction_subcategories table definition (6.2)
  - construction_projects table definition (8.2)
  - construction detail tables: construction_gallery, construction_milestones, construction_project_financials, construction_project_milestones
- DTO sources:
  - `pmo-backend\src\construction-projects\dto\*.ts` (create/update/query)
  - `pmo-backend\src\construction-subcategories\dto\*.ts`
- Migration file reviewed:
  - `database\database draft\2026_01_12\pmo_migration_google_oauth.sql` (confirmed unrelated to construction modules)